<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weekly Class Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .details-panel {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out, padding-top 0.5s ease-in-out;
        }
        .details-panel.open {
            max-height: 1000px; /* Adjust as needed */
            padding-top: 1rem; /* 16px */
        }
        .topic-button svg.arrow {
            transition: transform 0.3s ease;
        }
        .topic-button.open svg.arrow {
            transform: rotate(90deg);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>

<body class="text-gray-800">
    <div class="p-4 sm:p-6 lg:p-8">
        <div class="bg-white rounded-2xl shadow-lg p-6 sm:p-8">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">Weekly Class Schedule</h1>
                    <p class="text-sm text-gray-500">Dept. of Pathology and Lab Medicine, AIIMS Bhopal</p>
                    <p id="week-range" class="text-sm text-gray-500 mt-1">Loading week range...</p>
                </div>
                <div class="flex flex-col sm:flex-row items-center gap-4 mt-4 sm:mt-0 w-full sm:w-auto">
                    <div class="relative w-full sm:w-64">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                        </div>
                        <input type="text" id="search-input" placeholder="Search topic or faculty..." class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg leading-5 bg-white placeholder-gray-500 focus:outline-none focus:placeholder-gray-400 focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div class="flex items-center space-x-2">
                        <button id="prev-week" class="p-2 rounded-lg bg-gray-100 hover:bg-gray-200 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                        </button>
                        <button id="today" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-3 rounded-lg text-sm transition-colors">Today</button>
                        <button id="next-week" class="p-2 rounded-lg bg-gray-100 hover:bg-gray-200 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="mb-8 border-t border-gray-200 pt-6">
                 <a href="https://drive.google.com/file/d/1Whoi35EpE4FRQFqLLTZX2TR_A7jMBUXW/view?usp=drive_link" target="_blank" class="inline-flex items-center bg-green-100 text-green-800 font-semibold py-2 px-4 rounded-lg text-sm transition-colors hover:bg-green-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    View Approved Schedule (PDF)
                </a>
            </div>


            <div id="dashboard-content" class="overflow-x-auto">
                <!-- Classes will be dynamically inserted here -->
                <p class="text-center text-gray-500 py-10">Loading schedule...</p>
            </div>
        </div>
    </div>

    <script>
        const googleSheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRO72s6aR0pRLGcn8uyS-Do5BJ-G3VCFg1pbRJS-QS4j8qYmNK5aj8J2JWhu6BdGLUOrq6wvSrBA4Jy/pub?gid=0&single=true&output=csv';
        let currentMonday = getStartOfWeek(new Date());
        let allClassData = [];

        document.addEventListener('DOMContentLoaded', () => {
            fetchAndRenderDashboard();
            document.getElementById('search-input').addEventListener('keyup', applyFilters);
            ['prev-week', 'next-week', 'today'].forEach(id => {
                document.getElementById(id).addEventListener('click', () => {
                    if (id === 'prev-week') currentMonday.setDate(currentMonday.getDate() - 7);
                    if (id === 'next-week') currentMonday.setDate(currentMonday.getDate() + 7);
                    if (id === 'today') currentMonday = getStartOfWeek(new Date());
                    applyFilters();
                });
            });
        });

        async function fetchAndRenderDashboard() {
            const dashboardContent = document.getElementById('dashboard-content');
            dashboardContent.innerHTML = `<p class="text-center text-gray-500 py-10 flex items-center justify-center"><svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Fetching live data...</p>`;
            try {
                const response = await fetch(`${googleSheetUrl}&t=${new Date().getTime()}`);
                if (!response.ok) throw new Error('Network response was not ok');
                const csvData = await response.text();
                allClassData = parseCSV(csvData);
                applyFilters();
            } catch (error) {
                console.error('Error fetching or parsing sheet data:', error);
                dashboardContent.innerHTML = `<p class="text-center text-red-500 font-semibold py-10">Could not load data from Google Sheet. Please check the URL and sharing settings.</p>`;
            }
        }

        function parseCSV(csv) {
            const lines = [];
            const csvData = csv.trim();
            const pattern = /(,|\r?\n|\r|^)(?:"([^"]*(?:""[^"]*)*)"|([^",\r\n]*))/gi;
            let matches, currentRow = [];
            pattern.lastIndex = 0;
            while (matches = pattern.exec(csvData)) {
                const delimiter = matches[1];
                if (delimiter.length && delimiter !== ',') {
                    lines.push(currentRow);
                    currentRow = [];
                }
                let value = matches[2] ? matches[2].replace(/""/g, '"') : matches[3];
                currentRow.push(value);
            }
            lines.push(currentRow);
            if (lines.length < 2) return [];
            const headers = lines.shift().map(h => h.trim());
            return lines.map(row => {
                if (row.length !== headers.length) return null;
                const classObj = {};
                headers.forEach((header, index) => {
                    classObj[header] = row[index] ? row[index].trim() : '';
                });
                return classObj;
            }).filter(Boolean);
        }
        
        function applyFilters() {
            const weekRangeEl = document.getElementById('week-range');
            const navButtons = ['prev-week', 'today', 'next-week'];
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            let classesToRender;

            if (searchTerm) {
                classesToRender = allClassData.filter(cls => {
                    const topicMatch = cls.Topic.toLowerCase().includes(searchTerm);
                    const teacher1Match = (cls['Faculty 1 Name'] || '').toLowerCase().includes(searchTerm);
                    const teacher2Match = (cls['Faculty 2 Name'] || '').toLowerCase().includes(searchTerm);
                    const teacher3Match = (cls['Faculty 3 Name'] || '').toLowerCase().includes(searchTerm);
                    const srMatch = (cls['SR Name'] || '').toLowerCase().includes(searchTerm);
                    const jrMatch = (cls['JR Name'] || '').toLowerCase().includes(searchTerm);
                    return cls['Start time'] && (topicMatch || teacher1Match || teacher2Match || teacher3Match || srMatch || jrMatch);
                });
                weekRangeEl.textContent = `Showing all results for "${searchTerm}"`;
                navButtons.forEach(id => document.getElementById(id).disabled = true);
            } else {
                const weekStart = new Date(currentMonday);
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekStart.getDate() + 5);
                updateWeekRange(weekStart, weekEnd);
                classesToRender = allClassData.filter(cls => {
                    const classDate = parseDate(cls.Date);
                    return classDate && cls['Start time'] && classDate >= weekStart && classDate <= weekEnd;
                });
                navButtons.forEach(id => document.getElementById(id).disabled = false);
            }
            renderDashboard(classesToRender);
        }

        function renderDashboard(classesToRender) {
            const dashboardContent = document.getElementById('dashboard-content');
            if (classesToRender.length === 0) {
                dashboardContent.innerHTML = `<p class="text-center text-gray-500 py-10">No classes match your criteria.</p>`;
                return;
            }
            let html = '<div class="space-y-6">';
            const groupedByDay = classesToRender.reduce((acc, cls) => {
                const dateKey = parseDate(cls.Date).toISOString().split('T')[0];
                (acc[dateKey] = acc[dateKey] || []).push(cls);
                return acc;
            }, {});
            const sortedDates = Object.keys(groupedByDay).sort();
            sortedDates.forEach(dateKey => {
                const dayClasses = groupedByDay[dateKey];
                const dayName = dayClasses[0].Day;
                const dateObj = parseDate(dayClasses[0].Date);
                const formattedDate = formatDateDDMmmYYYY(dateObj);
                html += `
                    <div>
                        <h2 class="text-lg font-semibold mb-3 text-gray-800">${dayName}, <span class="text-indigo-600">${formattedDate}</span></h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                `;
                dayClasses.forEach((cls, index) => {
                    const uniqueId = `${dateKey}-${index}`;
                    html += createCardHTML(cls, uniqueId);
                });
                html += `</div></div>`;
            });
            html += '</div>';
            dashboardContent.innerHTML = html;
        }

        function createCardHTML(cls, uniqueId) {
            return `
                <div class="card bg-white p-4 rounded-lg border border-gray-200 flex flex-col">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="flex items-center text-xs text-gray-500 mb-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                <span>${formatTimeAMPM(cls['Start time'])} - ${formatTimeAMPM(cls['End Time'])}</span>
                            </div>
                            <button onclick="toggleDetails('${uniqueId}')" class="topic-button w-full text-left flex justify-between items-center group">
                                <p class="font-bold text-base text-gray-900 group-hover:text-indigo-600 transition-colors">${cls.Topic}</p>
                                <svg xmlns="http://www.w3.org/2000/svg" class="arrow h-5 w-5 text-gray-400 group-hover:text-indigo-600 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                            </button>
                             <div class="flex items-center text-xs text-gray-500 capitalize mt-1">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" /></svg>
                                <span>${cls.TLM}</span>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3 pt-3 border-t border-gray-200">
                        ${getTeacherLinks(cls)}
                    </div>
                    <div id="${uniqueId}" class="details-panel">
                        ${createDetailsPanel(cls)}
                    </div>
                </div>
            `;
        }
        
        function createDetailsPanel(cls) {
            const cbmeCompNoLines = cls['CBME Competency No.'].split(/[\n, ]+/).map(item => item.trim()).filter(Boolean);
            const lectureContentLines = cls['Lecture Content as per CBME'].split('\n').map(item => item.trim());
            const domainLines = cls['Domain (K/S/A/C)'].split(/\s+/).filter(Boolean);
            const levelLines = cls['Level (K/KH/SH/P)'].split(/\s+/).filter(Boolean);
            const coreLines = cls['Core (Y/N)'].split(/\s+/).filter(Boolean);

            let tableRows = '';
            const maxRows = Math.max(lectureContentLines.length, cbmeCompNoLines.length);
            for (let i = 0; i < maxRows; i++) {
                tableRows += `
                    <tr class="border-b last:border-b-0">
                        <td class="py-1 px-2">${cbmeCompNoLines[i] || ''}</td>
                        <td class="py-1 px-2">${lectureContentLines[i] || ''}</td>
                        <td class="py-1 px-2">${domainLines[i] || ''}</td>
                        <td class="py-1 px-2">${levelLines[i] || ''}</td>
                        <td class="py-1 px-2">${coreLines[i] || ''}</td>
                    </tr>
                `;
            }

            return `
                <div class="text-xs bg-gray-50 p-3 rounded-md mt-2">
                    ${cls['CBME Chapter Topic'] ? `<p class="font-semibold mb-1">Chapter: <span class="font-normal">${cls['CBME Chapter Topic']}</span></p>` : ''}
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="bg-gray-200">
                                    <th class="py-1 px-2 font-semibold">Competency</th>
                                    <th class="py-1 px-2 font-semibold">Content</th>
                                    <th class="py-1 px-2 font-semibold">Domain</th>
                                    <th class="py-1 px-2 font-semibold">Level</th>
                                    <th class="py-1 px-2 font-semibold">Core</th>
                                </tr>
                            </thead>
                            <tbody>${tableRows}</tbody>
                        </table>
                    </div>
                </div>
            `;
        }
        
        function toggleDetails(id) {
            const panel = document.getElementById(id);
            const button = panel.parentElement.querySelector('.topic-button');
            panel.classList.toggle('open');
            button.classList.toggle('open');
        }

        function getTeacherLinks(cls) {
            let facultyHtml = '';
            let srHtml = '';
            let jrHtml = '';
            
            const faculty = [
                { name: cls['Faculty 1 Name'], mobile: cls['Faculty 1 Telephone No.'] },
                { name: cls['Faculty 2 Name'], mobile: cls['Faculty 2 Telephone No.'] },
                { name: cls['Faculty 3 Name'], mobile: cls['Faculty 3 Telephone No.'] }
            ];

            const srNames = (cls['SR Name'] || '').split(/,|\n/).map(s => s.trim()).filter(Boolean);
            const srMobiles = (cls['SR Telephone No.'] || '').split(/,|\n/).map(s => s.trim()).filter(Boolean);
            const jrNames = (cls['JR Name'] || '').split(/,|\n/).map(s => s.trim()).filter(Boolean);
            const jrMobiles = (cls['JR Telephone No.'] || '').split(/,|\n/).map(s => s.trim()).filter(Boolean);

            let facultyLinks = '';
            faculty.forEach(person => {
                if (person.name && person.mobile) {
                    const message = generateWhatsAppMessage(cls, person.name);
                    const waLink = `https://wa.me/${person.mobile.replace(/\D/g, '')}?text=${encodeURIComponent(message)}`;
                    facultyLinks += `<a href="${waLink}" target="_blank" class="flex items-center bg-indigo-100 text-indigo-800 text-xs font-medium px-2.5 py-1 rounded-full hover:bg-indigo-200 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg>
                                ${person.name}
                              </a>`;
                }
            });
            if (facultyLinks) {
                facultyHtml = `<div class="w-full"><p class="font-semibold text-xs text-gray-700 mb-2">Faculty:</p><div class="flex flex-wrap gap-2">${facultyLinks}</div></div>`;
            }

            let srLinks = '';
            srNames.forEach((name, i) => {
                if (name && srMobiles[i]) {
                    const message = generateWhatsAppMessage(cls, name);
                    const waLink = `https://wa.me/${srMobiles[i].replace(/\D/g, '')}?text=${encodeURIComponent(message)}`;
                    srLinks += `<a href="${waLink}" target="_blank" class="flex items-center bg-gray-100 text-gray-800 text-xs font-medium px-2.5 py-1 rounded-full hover:bg-gray-200 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg>
                                ${name}
                              </a>`;
                }
            });
             if (srLinks) {
                srHtml = `<div class="w-full mt-2"><p class="font-semibold text-xs text-gray-700 mb-2">Senior Residents:</p><div class="flex flex-wrap gap-2">${srLinks}</div></div>`;
            }

            let jrLinks = '';
            jrNames.forEach((name, i) => {
                if (name && jrMobiles[i]) {
                    const message = generateWhatsAppMessage(cls, name);
                    const waLink = `https://wa.me/${jrMobiles[i].replace(/\D/g, '')}?text=${encodeURIComponent(message)}`;
                    jrLinks += `<a href="${waLink}" target="_blank" class="flex items-center bg-gray-100 text-gray-800 text-xs font-medium px-2.5 py-1 rounded-full hover:bg-gray-200 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg>
                                ${name}
                              </a>`;
                }
            });
             if (jrLinks) {
                jrHtml = `<div class="w-full mt-2"><p class="font-semibold text-xs text-gray-700 mb-2">Junior Residents:</p><div class="flex flex-wrap gap-2">${jrLinks}</div></div>`;
            }

            const combinedHtml = facultyHtml + srHtml + jrHtml;
            return combinedHtml || '<p class="text-xs text-gray-500">No personnel assigned.</p>';
        }

        function generateWhatsAppMessage(cls, teacherName) {
            const date = parseDate(cls.Date);
            const startTime = combineDateAndTime(date, cls['Start time']);
            if (!startTime) return `Reminder for ${cls.Topic} for ${teacherName}.`;
            const dayOfWeek = cls.Day;
            const formattedDate = date.toLocaleDateString('en-GB', { day: '2-digit', month: 'long', year: 'numeric' });
            const startTimeOnly = formatTimeAMPM(cls['Start time']);
            return `Dear ${teacherName},\n\nThis is a gentle reminder for your upcoming academic session scheduled for the MBBS 2024 Batch:\n\n*Topic:* *${cls.Topic}*\n*When:* *${dayOfWeek}, ${formattedDate} at ${startTimeOnly}*\nTeaching Learning Method: ${cls.TLM}\nFaculty/Host:            ${teacherName}\nBatch:                   MBBS 2024\n\nKindly let us know in advance if any support or adjustments are required.\n\nWarm regards,\nDr. Shakti Kumar Yadav`;
        }
        
        function getStartOfWeek(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            d.setHours(0, 0, 0, 0);
            return new Date(d.setDate(diff));
        }

        function updateWeekRange(start, end) {
            const options = { month: 'long', day: 'numeric', year: 'numeric' };
            document.getElementById('week-range').textContent = `${start.toLocaleDateString('en-US', options)} - ${end.toLocaleDateString('en-US', options)}`;
        }
        
        function parseDate(dateString) {
            if (!dateString || typeof dateString !== 'string') return null;
            const parts = dateString.split('/');
            if (parts.length !== 3) return null;
            const day = parseInt(parts[0], 10);
            const month = parseInt(parts[1], 10) - 1;
            const year = parseInt(parts[2], 10);
            const date = new Date(year, month, day);
            if (date.getFullYear() === year && date.getMonth() === month && date.getDate() === day) return date;
            return null;
        }

        function combineDateAndTime(dateObj, timeStr) {
            if (!dateObj || typeof timeStr !== 'string' || timeStr.indexOf(':') === -1) return null;
            const [hours, minutes] = timeStr.split(':');
            const newDate = new Date(dateObj);
            newDate.setHours(parseInt(hours, 10));
            newDate.setMinutes(parseInt(minutes, 10));
            newDate.setSeconds(0);
            newDate.setMilliseconds(0);
            return newDate;
        }

        function formatDateDDMmmYYYY(date) {
            const d = new Date(date);
            const day = String(d.getDate()).padStart(2, '0');
            const month = d.toLocaleString('en-GB', { month: 'short' });
            const year = d.getFullYear();
            return `${day} ${month} ${year}`;
        }

        function formatTimeAMPM(timeStr) {
            if (!timeStr) return '';
            const [hours, minutes] = timeStr.split(':');
            const h = parseInt(hours, 10);
            const ampm = h >= 12 ? 'PM' : 'AM';
            const formattedHours = h % 12 || 12;
            return `${String(formattedHours).padStart(2, '0')}:${minutes} ${ampm}`;
        }
    </script>
</body>
</html>
